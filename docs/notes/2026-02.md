# 2026-02 작업 로그

## 2026-02 (System.Drawing.Common 불필요한 PackageReference 제거)

### 수행한 작업 요약
NU1510 경고 해소. net10.0-windows 플랫폼에 System.Drawing.Common이 이미 포함되어 있으므로 .csproj의 명시적 PackageReference를 제거. App.xaml.cs에서 System.Drawing.Icon, SystemIcons 등을 직접 사용하지만 플랫폼 제공으로 정상 동작 확인.

### 변경된 파일 목록
- `MailTrayNotifier.csproj` - System.Drawing.Common PackageReference 제거

### 검증 결과
- 빌드: 성공
- 테스트: 해당 없음
- 린트: 해당 없음

---

## 2026-02 (About 메뉴 아이콘 업데이트 가능 시 변경)

### 수행한 작업 요약
최신 버전이 있을 때 About 메뉴 아이콘을 Info24에서 CloudArrowDown24로 자동 변경. SettingsViewModel.IsUpdateAvailable PropertyChanged 이벤트를 구독하여 실시간 반영.

### 변경된 파일 목록
- `MainWindow.xaml.cs` - PropertyChanged 이벤트 구독, UpdateAboutIcon() 메서드 추가

### 검증 결과
- 빌드: 성공
- README.md 갱신: 해당 없음 (외부 인터페이스 변경 없음)

## 2026-02 (AboutPage에 공식 웹 사이트 링크 추가)

### 수행한 작업 요약
AboutPage의 최신 버전 카드 아래에 "자세한 내용은 공식 웹 사이트로 이동하세요." 문구 추가. "공식 웹 사이트" 텍스트를 Hyperlink로 구현하여 클릭 시 브라우저에서 프로젝트 페이지 열기. 5개 언어 다국어 지원.

### 변경된 파일 목록
- `Views/AboutPage.xaml` - TextBlock + Hyperlink 문구 추가
- `Resources/Strings.resx` - AboutWebsitePrefix, AboutWebsiteLink, AboutWebsiteSuffix 추가 (영문)
- `Resources/Strings.ko.resx` - 한국어 번역 추가
- `Resources/Strings.ja.resx` - 일본어 번역 추가
- `Resources/Strings.zh-CN.resx` - 중국어 간체 번역 추가
- `Resources/Strings.zh-TW.resx` - 중국어 번체 번역 추가
- `Resources/Strings.Designer.cs` - 속성 3개 추가

### 검증 결과
- 빌드: 성공
- README.md 갱신: 해당 없음 (외부 인터페이스 변경 없음)

## 2026-02 (AppVersion 레지스트리 읽기로 변경)

### 수행한 작업 요약
`AppVersion` 속성을 어셈블리 버전 대신 `HKLM\SOFTWARE\PJC\MailTrayNotifier\Version` 레지스트리에서 읽도록 변경. 레지스트리 값이 없는 경우 빈 문자열 반환.

### 변경된 파일 목록
- `ViewModels/SettingsViewModel.cs` - `AppVersion` getter를 레지스트리 읽기로 변경, 미사용 `System.Reflection` using 제거

### 검증 결과
- 빌드: 성공
- README.md 갱신: 해당 없음 (외부 인터페이스 변경 없음)

### 제한 사항
- 레지스트리 값이 없으면 `AppVersion`이 빈 문자열 → 업데이트 확인(`CheckForUpdateAsync`)에서 `Version.TryParse` 실패로 업데이트 비교 미수행

## 2026-02 (빌드 출력 배포 불필요 파일 삭제)

### 수행한 작업 요약
빌드 출력(bin) 디렉토리에서 배포에 불필요한 파일 및 폴더를 삭제하고, .nupkg 재생성을 방지하도록 프로젝트 설정 추가.

### 삭제 대상
| 파일/폴더 | 사유 |
|---|---|
| `*.pdb` | 디버그 심볼 (개발용) |
| `*.nupkg` | NuGet 패키지 (WinExe 앱에 불필요) |
| `settings.json` | 실행 중 생성되는 사용자 설정 데이터 |
| `mail_state.json` | 레거시 메일 상태 데이터 |
| `mail\` 폴더 | 실행 중 생성되는 메일 상태 데이터 |
| `logs\` 폴더 | 실행 중 생성되는 로그 파일 |

### 변경된 파일 목록
- `MailTrayNotifier.csproj` - `<IsPackable>false</IsPackable>` 추가

### 검증 결과
- 빌드: 성공
- README.md 갱신: 해당 없음 (기능/동작/설정 변경 없음)

## 2026-02 (업데이트 확인 로직 변경 및 Windows 알림 추가)

### 수행한 작업 요약
업데이트 확인 동작을 변경: 앱 시작 10분 후 1회 업데이트 확인 → 새 버전 있으면 Windows 토스트 알림 표시 (업데이트 버튼 포함). 설정 창을 열 때마다 업데이트 확인하여 About 페이지에 표시.

### 변경된 파일 목록
- `App.xaml.cs` - UpdateCheckService 필드, 10분 후 확인 타이머, ShowSettings에서 매번 확인 호출, CleanupResources 해제
- `ViewModels/SettingsViewModel.cs` - InitializeAsync에서 업데이트 확인 제거
- `Services/NotificationService.cs` - ShowUpdateAvailable 메서드, 토스트 업데이트 액션 핸들링 추가
- `Resources/Strings.resx` - UpdateAvailableTitle, UpdateAvailableMessage 추가
- `Resources/Strings.ko.resx` - 한국어 번역 추가
- `Resources/Strings.ja.resx` - 일본어 번역 추가
- `Resources/Strings.zh-CN.resx` - 중국어 간체 번역 추가
- `Resources/Strings.zh-TW.resx` - 중국어 번체 번역 추가
- `Resources/Strings.Designer.cs` - 자동 생성 코드에 속성 추가

### 검증 결과
- 빌드: 성공
- README.md 갱신: 기능 목록 설명 변경

### 제한 사항
- GitHub API Rate Limit: 인증 없이 시간당 60회 제한 (일반 사용에 충분)
- 설정 창 열 때마다 확인하지만 API 호출은 짧은 GET 요청이므로 부하 없음

## 2026-02 (GitHub 최신 버전 확인 및 업데이트 안내 기능 추가)

### 수행한 작업 요약
AboutPage에서 GitHub Releases API를 통해 최신 버전을 확인하고, 현재 버전보다 새로운 릴리스가 있으면 최신 버전과 업데이트 버튼을 표시하는 기능 추가.

### 변경된 파일 목록
- `Services/UpdateCheckService.cs` (신규) - GitHub API 호출 및 버전 비교 서비스
- `ViewModels/SettingsViewModel.cs` - 업데이트 확인 속성/명령 추가
- `Views/AboutPage.xaml` - 최신 버전 표시 UI 및 업데이트 버튼 추가
- `Resources/Strings.resx` - LatestVersionLabel, UpdateButton 추가
- `Resources/Strings.ko.resx` - 한국어 번역 추가
- `Resources/Strings.ja.resx` - 일본어 번역 추가
- `Resources/Strings.zh-CN.resx` - 중국어 간체 번역 추가
- `Resources/Strings.zh-TW.resx` - 중국어 번체 번역 추가
- `Resources/Strings.Designer.cs` - 자동 생성 코드에 속성 추가

### 검증 결과
- 빌드: 성공
- README.md 갱신: 기능 목록, 클래스 구조에 반영

### 제한 사항
- GitHub API Rate Limit: 인증 없이 시간당 60회 제한 (일반 사용에 충분)
- 업데이트 확인 실패 시 UI에 표시 없이 조용히 무시 (네트워크 오류 등)

## 2026-02-13 (좌측 메뉴 About 버튼 하단 배치)

### 수행한 작업 요약
MainWindow.xaml 좌측 내비게이션에서 MenuAbout 버튼이 다른 메뉴와 함께 상단에 나열되던 것을 하단에 고정 배치되도록 수정.

### 변경된 파일 목록
- `MainWindow.xaml` (좌측 내비게이션 레이아웃 변경)

### 상세 변경 내용
- 좌측 내비게이션의 `StackPanel`을 `DockPanel`(LastChildFill=False)로 변경
- MenuMail, MenuSettings: `DockPanel.Dock="Top"`으로 상단 배치
- MenuAbout: `DockPanel.Dock="Bottom"`으로 하단 고정 배치
- Margin을 `0,8,0,0`에서 `0,8,0,8`로 변경하여 하단 여백 추가

### 검증 결과
- 빌드: 성공 (경고 0건, 오류 0건)
- README.md 갱신: 불필요 (UI 레이아웃 미세 조정, 기능/동작/설정/외부 인터페이스 변경 없음)

---

## 2026-02-12 (Reset 시 테마/언어 미초기화 버그 수정)

### 수행한 작업 요약
`SettingsViewModel.Reset()` 메서드에서 초기화 시 테마와 언어가 시스템 기본으로 초기화되지 않는 버그 수정.

### 변경된 파일 목록
- `ViewModels/SettingsViewModel.cs` (Reset 메서드에 테마/언어 초기화 로직 추가)

### 상세 변경 내용
- `_selectedThemeCode`를 빈 문자열로 초기화하고 `ApplyTheme("")` 호출 (시스템 기본 테마 복원)
- `_selectedLanguageCode`를 빈 문자열로 초기화하고 `ApplyLanguage("")` 호출 (시스템 기본 언어 복원)
- `OnPropertyChanged` 호출로 ComboBox UI 동기화
- 초기화 완료 메시지 후 `LanguageChanged?.Invoke()`로 UI 갱신 요청

### 수정 전 동작
1. 사용자가 "다크" 테마 + "한국어" 선택 후 초기화 실행
2. settings.json 삭제됨, 계정/IsRefreshEnabled는 초기화됨
3. **테마/언어는 그대로 유지** (ComboBox도 이전 선택 유지)
4. 앱 재시작 시에만 시스템 기본으로 복원

### 수정 후 동작
1. 초기화 실행 시 테마/언어가 즉시 시스템 기본으로 복원
2. ComboBox도 "시스템 기본"으로 변경
3. UI 갱신 이벤트 발생으로 전체 텍스트도 시스템 기본 언어로 갱신

### 검증 결과
- 빌드: 성공 (경고 0건, 오류 0건)
- README.md 갱신: 불필요 (기능/동작/설정/외부 인터페이스 변경 없음, 버그 수정)

---

## 2026-02-12 (테마 변경 기능 추가)

### 수행한 작업 요약

#### [1] 테마 변경 기능 추가
GeneralSettingsPage 언어 설정 아래에 테마 변경 기능 추가 (시스템 기본 / 다크 / 라이트).

#### [2] MainWindow 하드코딩 배경색 제거
MainWindow.xaml의 하드코딩 배경색 4곳을 테마 리소스로 교체하여 테마 전환 시 배경이 정상 적용되도록 수정.
- `#151c26` (3곳) → Transparent (Mica 배경 투과)
- `#21262d` (1곳) → `CardBackgroundFillColorDefaultBrush` (테마 연동)

### 변경된 파일 목록
- `Models/ThemeOption.cs` (신규) - 테마 선택 옵션 record
- `Models/MailSettingsCollection.cs` - Theme 속성 추가
- `Services/SettingsService.cs` - LoadThemeSync 메서드 추가, SaveCollectionAsync에서 Theme 보존
- `Resources/Strings.resx` - 영문 테마 문자열 5건 추가
- `Resources/Strings.ko.resx` - 한국어 테마 문자열 5건 추가
- `Resources/Strings.ja.resx` - 일본어 테마 문자열 5건 추가
- `Resources/Strings.zh-CN.resx` - 중국어 간체 테마 문자열 5건 추가
- `Resources/Strings.zh-TW.resx` - 중국어 번체 테마 문자열 5건 추가
- `Resources/Strings.Designer.cs` - 테마 리소스 속성 5건 추가
- `ViewModels/SettingsViewModel.cs` - AvailableThemes, SelectedThemeCode, ChangeThemeAsync, ApplyTheme 추가
- `Views/GeneralSettingsPage.xaml` - 테마 ComboBox UI 추가
- `App.xaml.cs` - ApplyStartupTheme 메서드 추가 (시작 시 저장된 테마 적용)

### 검증 결과
- 빌드: 성공 (경고 0건, 오류 0건)
- README.md 갱신: 필요 (기능 추가)

---

## 2026-02-12 (배포 전 코드 검증 및 이슈 수정)

### 수행한 작업 요약
배포 전 전체 코드에 대해 메모리 누수, 리소스 관리, 최적화, 스레드 안전성을 정적 분석. 발견된 이슈 3건 수정.

### 변경된 파일 목록
- `MailTrayNotifier.csproj` (warning.ico CopyToOutputDirectory 추가)
- `MainWindow.xaml.cs` (ForceClose에서 ViewModel.Dispose 호출 추가)
- `README.md` (최대 계정 수 5 -> 10 수정)

### 상세 변경 내용

#### 1. warning.ico 배포 누락 수정
- `<Content Include="Assets\warning.ico" />` -> `CopyToOutputDirectory=PreserveNewest` 추가
- start.ico, stop.ico와 동일한 패턴으로 통일
- 수정 전: 커스텀 warning 아이콘이 출력 디렉터리에 복사되지 않아 SystemIcons.Warning으로 대체됨

#### 2. SettingsViewModel.Dispose() 미호출 수정
- `MainWindow.ForceClose()`에서 `ViewModel.Dispose()` 호출 추가
- SettingsViewModel이 구독한 MailPollingService.AccountErrorOccurred/AccountErrorCleared 이벤트가 정상 해제됨

#### 3. README.md 최대 계정 수 불일치 수정
- "최대 5개 계정까지 지원" -> "최대 10개 계정까지 지원"
- MailConstants.MaxAccounts = 10과 일치하도록 수정

### 검증 결과
- 빌드: 성공 (경고 0건, 오류 0건)
- README.md 갱신: 완료

---

## 2026-02-08 (GeneralSettingsPage 언어 변경 기능 추가)

### 수행한 작업 요약
설정 화면(GeneralSettingsPage)에 언어 변경 기능을 추가. 시스템 기본 / English / 한국어 중 선택 가능하며, 변경 시 즉시 전체 UI가 갱신됨.

### 변경된 파일 목록
- `Models/MailSettingsCollection.cs` (Language 속성 추가)
- `Models/LanguageOption.cs` (신규 - 언어 옵션 record)
- `Services/SettingsService.cs` (SaveCollectionAsync에 Language 포함, LoadLanguageSync 추가)
- `Resources/Strings.resx` (LanguageTitle, LanguageDescription, LanguageSystemDefault 추가)
- `Resources/Strings.ko.resx` (한국어 번역 추가)
- `Resources/Strings.Designer.cs` (3개 프로퍼티 추가)
- `ViewModels/SettingsViewModel.cs` (AvailableLanguages, SelectedLanguageCode, ChangeLanguageAsync, ApplyLanguage, LanguageChanged 이벤트)
- `Views/GeneralSettingsPage.xaml` (언어 선택 ComboBox 추가)
- `MainWindow.xaml` (TitleText, NavMailText, NavSettingsText, NavAboutText에 x:Name 추가)
- `MainWindow.xaml.cs` (OnLanguageChanged 핸들러 - 페이지 캐시 클리어, 정적 텍스트 갱신, 트레이 갱신)
- `App.xaml.cs` (SystemDefaultCulture 캡처, ApplyStartupLanguage, RefreshTrayMenuLanguage, settingsItem/exitItem 필드)

### 검증 결과
- 빌드: 성공 (경고 0건, 오류 0건)
- README.md 갱신: 필요 (새 기능 추가)

---

## 2026-02-08 (하드코딩된 문자열 리소스 파일로 이동)

### 수행한 작업 요약
프로젝트 전체에서 하드코딩된 사용자 노출 문자열 12개를 리소스 파일(`Strings.resx`, `Strings.ko.resx`)로 이동하고, 하드코딩된 한국어 문자열 비교를 리소스 키 직접 비교로 수정.

### 변경된 파일 목록
- `Resources/Strings.resx` (12개 키 추가: PortPlaceholder, UseSslLabel, ToggleOn, ToggleOff, MailServerAuthFailed, MailServerConnectionFailed, MailServerTimeout, MailServerConnectionError, MailAccountAuthFailed, MailAuthError, AccountMailCheckError)
- `Resources/Strings.ko.resx` (12개 한국어 번역 추가)
- `Resources/Strings.Designer.cs` (12개 프로퍼티 추가)
- `MainWindow.xaml` (About 텍스트 리소스 참조로 변경)
- `Views/MailSettingsPage.xaml` (Port PlaceholderText 2건, SSL 체크박스 Content 리소스 참조로 변경)
- `Views/GeneralSettingsPage.xaml` (ToggleSwitch OnContent/OffContent 2건 리소스 참조로 변경)
- `Services/MailClientService.cs` (6개 한국어 오류 메시지 리소스 참조로 변경, using 추가)
- `Services/MailPollingService.cs` (1개 알림 메시지 리소스 참조로 변경, using 추가)
- `ViewModels/SettingsViewModel.cs` (하드코딩된 `"공백이 제거됩니다"` 비교를 `Strings.AccountNameTrimmed` 직접 비교로 수정)

### 검증 결과
- 빌드: 성공 (경고 0건, 오류 0건)
- README.md 갱신: 불필요 (기능/동작/설정/외부 인터페이스 변경 없음)

---

## 2026-02-08 (MailSettingsPage.xaml.cs 깨진 한글 주석 수정)

### 수행한 작업 요약
`MailSettingsPage.xaml.cs`의 깨진 한글 주석을 UTF-8로 재작성.

### 변경된 파일 목록
- `Views/MailSettingsPage.xaml.cs`

### 상세 변경 내용
- 18~20줄: `���ڸ� �Է� ���` -> `숫자만 입력 허용`
- 26~28줄: `�ٿ��ֱ� �� ���ڸ� ���` -> `붙여넣기 시 숫자만 허용`

### 검증 결과
- 빌드: 성공 (경고 0건, 오류 0건)
- dotnet format: 완료
- README.md 갱신: 불필요 (기능/동작/설정/외부 인터페이스 변경 없음)

---

## 2026-02-08 (폴링 재시작 시 오류 알림 버그 수정)

### 수행한 작업 요약
계정 수정 후 저장 시 폴링 중지/재시작 과정에서 오류 알림이 발생하는 버그 수정.

### 변경된 파일 목록
- `Services/MailPollingService.cs`

### 상세 변경 내용

#### 원인 분석
저장 시 `RestartAllAccountPolling()` -> `StopAllAccountPolling()` + `StartAllAccountPolling()` 순서로 실행.

**문제 1**: `StopAllAccountPolling`에서 CTS 취소 직후 `CleanupAccountResources`로 SemaphoreSlim을 즉시 dispose. 비동기 폴링 태스크가 아직 이 SemaphoreSlim을 보유 중이면, `CheckAccountWithLockAsync`의 `finally` 블록에서 `accountLock.Release()` 호출 시 `ObjectDisposedException` 발생. 이 예외는 `OperationCanceledException`이 아니므로 일반 catch 블록에 도달하여 사용자에게 오류 알림 표시.

**문제 2**: 일반 catch 블록에서 `_accountPollingTasks.TryRemove(accountKey, ...)`로 새로 시작된 폴링 태스크의 CTS를 잘못 제거/dispose하여 새 폴링도 중단.

#### 수정 내용
1. `StopAllAccountPolling()`: `CleanupAccountResources(kvp.Key)` 호출 제거. SemaphoreSlim은 `Dispose()`에서 정리.
2. `RunAccountPollingAsync`: 시그니처를 `CancellationToken` -> `CancellationTokenSource`로 변경. 일반 catch 블록에서 현재 CTS가 자신의 것인지 확인 후 오류 처리 수행 (stale 태스크의 부수 예외 무시).

### 검증 결과
- 빌드: 성공 (경고 0건, 오류 0건)
- dotnet format: 완료
- README.md 갱신: 불필요 (기능/동작/설정/외부 인터페이스 변경 없음)

### 동일 실수를 반복하지 않도록 참고
- 비동기 태스크가 보유 중인 리소스(SemaphoreSlim 등)를 동기 메서드에서 즉시 dispose하지 말 것
- fire-and-forget 비동기 태스크의 오류 핸들러에서 공유 딕셔너리 항목을 제거할 때, 자신의 항목인지 확인할 것

---

## 2026-02-08 (미사용 코드 삭제)

### 수행한 작업 요약
빌드 경고(CS0168), 미사용 파일, 미사용 상수를 삭제하여 코드를 정리.

### 변경된 파일 목록
- `Services/NotificationService.cs` (CS0168 경고 수정: `catch (Exception ex)` -> `catch (Exception)`)
- `Constants/MailConstants.cs` (미사용 상수 `DefaultPop3NonSslPort`, `DefaultSmtpNonSslPort` 삭제)

### 삭제된 파일 목록
- `Models/MailStateFile.cs` (프로젝트 전체에서 참조 없음)
- `Helpers/PasswordBoxHelper.cs` (프로젝트 전체에서 참조 없음)
- `Helpers/` 폴더 (빈 폴더 삭제)

### 상세 변경 내용

#### 1. CS0168 경고 수정 - NotificationService.cs (line 88)
- `catch (Exception ex)` -> `catch (Exception)` (사용하지 않는 변수 제거)
- 다른 2곳의 `catch (Exception ex)`는 Debug.WriteLine에서 사용 중이므로 유지

#### 2. 미사용 파일 삭제 - MailStateFile.cs
- Grep 검증: 자기 파일(Models/MailStateFile.cs)에서만 참조, 다른 .cs/.xaml 파일에서 사용 없음
- MailStateStore가 내부적으로 Dictionary<string, List<string>>를 직접 사용

#### 3. 미사용 파일 삭제 - PasswordBoxHelper.cs
- Grep 검증: 자기 파일(Helpers/PasswordBoxHelper.cs)에서만 참조, XAML/C#에서 사용 없음
- WPF-UI의 PasswordBox가 직접 바인딩 지원

#### 4. 미사용 상수 삭제 - MailConstants.cs (line 53-62)
- `DefaultPop3NonSslPort` (110), `DefaultSmtpNonSslPort` (25) 삭제
- Grep 검증: MailConstants.cs에서만 정의, 다른 파일에서 참조 없음

### 삭제하지 않은 항목
- SMTP 관련 코드 (SmtpServer, SmtpPort 등): 사용자 요청에 따라 유지

### 검증 결과
- 빌드: 성공 (경고 0건, 오류 0건)
- dotnet format: 완료 (수정 파일 범위 내)
- README.md 갱신: 불필요 (기능/동작/설정/외부 인터페이스 변경 없음)

---

## 2026-02-08 (코드 분석 이슈 5건 수정)

### 수행한 작업 요약
코드 리뷰에서 발견된 메모리 누수, 중복 호출, 인코딩 깨짐 등의 이슈를 수정. 기능 변경 없이 기존 동작 유지.

### 변경된 파일 목록
- `App.xaml.cs` (SaveUidsRequested 이벤트 구독 해제 추가)
- `ViewModels/SettingsViewModel.cs` (SaveIsRefreshEnabledAsync 중복 Start/Stop 호출 제거)
- `Services/MailStateStore.cs` (Clear/ClearAccount에서 SemaphoreSlim dispose 추가)
- `Models/MailInfo.cs` (깨진 한글 주석 UTF-8로 재작성)
- `Services/MailPollingService.cs` (ApplySettings else 분기 정리)

### 상세 변경 내용

#### 1. [중간] NotificationService.SaveUidsRequested 이벤트 구독 해제 누락
- `App.xaml.cs` CleanupResources에 `_notificationService.SaveUidsRequested -= OnSaveUidsRequested` 추가
- `_notificationService.Shutdown()` 호출 전에 이벤트 해제
- 효과: 앱 종료 시 이벤트 구독 누수 방지

#### 2. [중간] SaveIsRefreshEnabledAsync 중복 Start/Stop 호출 제거
- `ApplySettings()` 내부에서 이미 Start/Stop을 처리하므로 이후의 중복 호출 제거
- 효과: 불필요한 Start/Stop 이중 호출 방지

#### 3. [낮음] MailStateStore._locks SemaphoreSlim 미해제
- `Clear()`: `_locks`의 모든 SemaphoreSlim dispose 후 clear 추가
- `ClearAccount()`: lock 해제 후 `_locks`에서 제거 및 dispose 추가
- 효과: 초기화/계정 삭제 시 SemaphoreSlim 메모리 누수 방지

#### 4. [낮음] MailInfo.cs 인코딩 깨짐
- 깨진 한글 주석을 UTF-8로 재작성

#### 5. [낮음] ApplySettings 불필요한 else 분기
- `isValid=false`이고 `isRefreshEnabled=true`인 경우 `RestartAllAccountPolling()` 대신 `Stop()` 호출
- 유효하지 않은 설정으로 폴링을 시작하는 것은 무의미

### 검증 결과
- 빌드: 성공 (경고 2건 - 기존 NotificationService.cs CS0168, 오류 0건)
- dotnet format: 완료 (수정 파일 범위 내)
- README.md 갱신: 불필요 (기능/동작/설정/외부 인터페이스 변경 없음)

---

## 2026-02-07 (MailPollingService 2건 버그 수정)

### 수행한 작업 요약
검증 과정에서 발견된 `MailPollingService`의 2건 버그 수정

### 변경된 파일 목록
- `Services/MailPollingService.cs`

### 상세 변경 내용

#### Step 1: [심각] 초기 즉시 확인 시 일시적 오류 -> 폴링 영구 중지
- **문제**: `RunAccountPollingAsync`에서 앱 시작 시 즉시 확인하는 `CheckAccountWithLockAsync`가 while 루프 바깥에 위치. 일시적 오류 발생 시 외부 catch에서 잡히지만 메서드가 종료되어 while 루프에 진입하지 못함 -> 해당 계정 폴링 영구 중지.
- **수정**: 초기 즉시 확인에 개별 try-catch 래핑. `OperationCanceledException`은 외부로 전파, 일시적 오류는 로그만 남기고 while 루프에 진입.
- **추가**: 외부 catch의 일시적 오류 핸들러 제거 (초기 확인에서 자체 처리하므로 더 이상 도달하지 않음, 루프 내부에서도 자체 처리됨)

#### Step 2: [중간] TryAdd 전에 비동기 Task 시작 -> 경쟁 상태
- **문제**: `StartAllAccountPolling()`에서 `RunAccountPollingAsync`를 fire-and-forget으로 실행한 후 `_accountPollingTasks.TryAdd`로 등록. Task가 즉시 실패하면 내부에서 `TryRemove`를 시도하지만 아직 Add가 안 되었을 수 있음.
- **수정**: `TryAdd`를 Task 시작 전으로 이동하여 등록 후 Task를 시작.

### 검증 결과
- 빌드: 성공 (경고 6건 - 기존 NotificationService.cs CS0168, 오류 0건)
- dotnet format: 완료 (수정 파일 범위 내)
- README.md 갱신: 불필요 (기능/동작/설정/외부 인터페이스 변경 없음)

### 동일 실수를 반복하지 않도록 참고
- 폴링 루프 진입 전 초기 확인도 루프 내부와 동일한 오류 처리 패턴을 적용할 것
- ConcurrentDictionary에 등록은 반드시 비동기 Task 시작 전에 수행할 것

---

## 2026-02-07 (코드 검토 이슈 전체 수정)

### 수행한 작업 요약
코드 검토에서 발견된 심각 3건, 중간 3건, 낮음 1건의 이슈를 모두 수정

### 변경된 파일 목록

#### 수정
- `Services/MailClientService.cs` (InnerException 보존)
- `Services/MailPollingService.cs` (폴링 루프 내 일시적 오류 처리, 중복 주석 제거)
- `Services/MailStateStore.cs` (데드락 수정 - LoadFromCacheOrFileAsync 추출)
- `Services/SettingsService.cs` (실제 비동기 I/O 적용)
- `App.xaml.cs` (fire-and-forget 예외 처리, 빈 예외 핸들러 진단 추가)
- `ViewModels/SettingsViewModel.cs` (fire-and-forget 예외 처리)
- `Models/AccountBackup.cs` (깨진 한글 주석 UTF-8로 재작성)
- `Constants/MailConstants.cs` (깨진 한글 주석 UTF-8로 재작성)

### 상세 변경 내용

#### Step 1: [심각] MailClientService InnerException 보존
- ConnectAsync catch 블록 3곳: `throw new InvalidOperationException(message)` -> `throw new InvalidOperationException(message, ex)`
- AuthenticateAsync catch 블록 1곳: 동일 수정
- 효과: `MailPollingService.IsTransientNetworkError()`가 InnerException을 재귀 확인하여 일시적 오류 정확히 분류 가능

#### Step 2: [심각] MailPollingService 폴링 루프 일시적 오류 처리
- while 루프 내부에 개별 try-catch 추가
- `OperationCanceledException`은 재throw (취소 전파)
- 일시적 네트워크 오류는 `Debug.WriteLine` 후 다음 폴링까지 대기 (루프 계속)
- 영구적 오류는 그대로 외부 catch에서 처리
- 효과: 일시적 오류 시 폴링이 영구 중지되지 않음

#### Step 3: [심각] MailStateStore.SaveAsync() 데드락 수정
- `LoadFromCacheOrFileAsync` private 메서드 추출
- `LoadAsync`: 락 획득 -> `LoadFromCacheOrFileAsync` 호출
- `SaveAsync`: 락 획득 -> 캐시 미스 시 `LoadFromCacheOrFileAsync` 호출 (락 재진입 없음)
- 효과: SaveAsync에서 LoadAsync 호출로 인한 데드락 방지

#### Step 4: [중간] SettingsService 실제 비동기 I/O 적용
- `LoadAsync()`: `File.ReadAllText` -> `File.ReadAllTextAsync`
- `LoadCollectionAsync()`: `File.ReadAllText` -> `File.ReadAllTextAsync`
- `SaveAsync()`: `File.WriteAllText` -> `File.WriteAllTextAsync`, `Task.CompletedTask` 제거
- `SaveCollectionAsync()`: `File.WriteAllText` -> `File.WriteAllTextAsync`, `Task.CompletedTask` 제거
- 효과: UI 스레드 블로킹 방지

#### Step 5: [중간] Fire-and-Forget 예외 처리 보강
- `App.xaml.cs`: `InitializeServicesAsync()` -> `.ContinueWith()`로 예외 진단
- `App.xaml.cs`: `OnSaveUidsRequested` 빈 catch -> `Debug.WriteLine` 추가
- `SettingsViewModel.cs`: `SaveAllAccountsAsync()` 2곳 -> `.ContinueWith()`로 예외 진단
- 효과: 무시된 예외가 디버그 출력에 기록됨

#### Step 6: [중간] 빈 예외 핸들러에 진단 정보 추가
- `OnUnhandledException`: `Debug.WriteLine`으로 예외 타입, 메시지, StackTrace 기록
- `OnDispatcherUnhandledException`: `Debug.WriteLine`으로 예외 타입, 메시지, StackTrace 기록 (`e.Handled = true` 유지)
- 효과: 미처리 예외 원인 파악 가능

#### Step 7: [낮음] 파일 인코딩 수정
- `Models/AccountBackup.cs`: 깨진 주석 -> 올바른 한글로 재작성
- `Constants/MailConstants.cs`: 깨진 주석 -> 올바른 한글로 재작성
- UTF-8로 저장

### 추가 수정 (코드 리뷰)
- `MailPollingService.cs`: `CleanupAccountResources` 메서드 위 중복 `<summary>` 주석 제거

### 검증 결과
- 빌드: 성공 (경고 6건 - 기존 NotificationService.cs CS0168, 오류 0건)
- dotnet format: 완료 (수정 파일 범위 내)
- 코드 리뷰: 심각한 문제 없음
- 데드락 패턴: 해결 확인
- 메모리 누수: 문제 없음

### 이슈 및 조치 사항
- 기존 NotificationService.cs의 CS0168 경고 6건은 수정 범위 외로 유지

### 동일 실수를 반복하지 않도록 참고
- 예외 래핑 시 반드시 원본 예외를 InnerException으로 전달할 것
- 폴링 루프에서 예외 처리는 루프 내부에 배치하여 루프가 중단되지 않도록 할 것
- 락을 이미 보유한 상태에서 같은 락을 획득하는 메서드를 호출하지 말 것 (데드락)
- async 메서드에서 동기 File I/O를 사용하지 말 것
- fire-and-forget 호출에는 반드시 예외 핸들러를 추가할 것
- 파일은 반드시 UTF-8로 저장할 것
