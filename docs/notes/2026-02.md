# 2026-02 작업 로그

## 2026-02-07 (MailPollingService 2건 버그 수정)

### 수행한 작업 요약
검증 과정에서 발견된 `MailPollingService`의 2건 버그 수정

### 변경된 파일 목록
- `Services/MailPollingService.cs`

### 상세 변경 내용

#### Step 1: [심각] 초기 즉시 확인 시 일시적 오류 -> 폴링 영구 중지
- **문제**: `RunAccountPollingAsync`에서 앱 시작 시 즉시 확인하는 `CheckAccountWithLockAsync`가 while 루프 바깥에 위치. 일시적 오류 발생 시 외부 catch에서 잡히지만 메서드가 종료되어 while 루프에 진입하지 못함 -> 해당 계정 폴링 영구 중지.
- **수정**: 초기 즉시 확인에 개별 try-catch 래핑. `OperationCanceledException`은 외부로 전파, 일시적 오류는 로그만 남기고 while 루프에 진입.
- **추가**: 외부 catch의 일시적 오류 핸들러 제거 (초기 확인에서 자체 처리하므로 더 이상 도달하지 않음, 루프 내부에서도 자체 처리됨)

#### Step 2: [중간] TryAdd 전에 비동기 Task 시작 -> 경쟁 상태
- **문제**: `StartAllAccountPolling()`에서 `RunAccountPollingAsync`를 fire-and-forget으로 실행한 후 `_accountPollingTasks.TryAdd`로 등록. Task가 즉시 실패하면 내부에서 `TryRemove`를 시도하지만 아직 Add가 안 되었을 수 있음.
- **수정**: `TryAdd`를 Task 시작 전으로 이동하여 등록 후 Task를 시작.

### 검증 결과
- 빌드: 성공 (경고 6건 - 기존 NotificationService.cs CS0168, 오류 0건)
- dotnet format: 완료 (수정 파일 범위 내)
- README.md 갱신: 불필요 (기능/동작/설정/외부 인터페이스 변경 없음)

### 동일 실수를 반복하지 않도록 참고
- 폴링 루프 진입 전 초기 확인도 루프 내부와 동일한 오류 처리 패턴을 적용할 것
- ConcurrentDictionary에 등록은 반드시 비동기 Task 시작 전에 수행할 것

---

## 2026-02-07 (코드 검토 이슈 전체 수정)

### 수행한 작업 요약
코드 검토에서 발견된 심각 3건, 중간 3건, 낮음 1건의 이슈를 모두 수정

### 변경된 파일 목록

#### 수정
- `Services/MailClientService.cs` (InnerException 보존)
- `Services/MailPollingService.cs` (폴링 루프 내 일시적 오류 처리, 중복 주석 제거)
- `Services/MailStateStore.cs` (데드락 수정 - LoadFromCacheOrFileAsync 추출)
- `Services/SettingsService.cs` (실제 비동기 I/O 적용)
- `App.xaml.cs` (fire-and-forget 예외 처리, 빈 예외 핸들러 진단 추가)
- `ViewModels/SettingsViewModel.cs` (fire-and-forget 예외 처리)
- `Models/AccountBackup.cs` (깨진 한글 주석 UTF-8로 재작성)
- `Constants/MailConstants.cs` (깨진 한글 주석 UTF-8로 재작성)

### 상세 변경 내용

#### Step 1: [심각] MailClientService InnerException 보존
- ConnectAsync catch 블록 3곳: `throw new InvalidOperationException(message)` -> `throw new InvalidOperationException(message, ex)`
- AuthenticateAsync catch 블록 1곳: 동일 수정
- 효과: `MailPollingService.IsTransientNetworkError()`가 InnerException을 재귀 확인하여 일시적 오류 정확히 분류 가능

#### Step 2: [심각] MailPollingService 폴링 루프 일시적 오류 처리
- while 루프 내부에 개별 try-catch 추가
- `OperationCanceledException`은 재throw (취소 전파)
- 일시적 네트워크 오류는 `Debug.WriteLine` 후 다음 폴링까지 대기 (루프 계속)
- 영구적 오류는 그대로 외부 catch에서 처리
- 효과: 일시적 오류 시 폴링이 영구 중지되지 않음

#### Step 3: [심각] MailStateStore.SaveAsync() 데드락 수정
- `LoadFromCacheOrFileAsync` private 메서드 추출
- `LoadAsync`: 락 획득 -> `LoadFromCacheOrFileAsync` 호출
- `SaveAsync`: 락 획득 -> 캐시 미스 시 `LoadFromCacheOrFileAsync` 호출 (락 재진입 없음)
- 효과: SaveAsync에서 LoadAsync 호출로 인한 데드락 방지

#### Step 4: [중간] SettingsService 실제 비동기 I/O 적용
- `LoadAsync()`: `File.ReadAllText` -> `File.ReadAllTextAsync`
- `LoadCollectionAsync()`: `File.ReadAllText` -> `File.ReadAllTextAsync`
- `SaveAsync()`: `File.WriteAllText` -> `File.WriteAllTextAsync`, `Task.CompletedTask` 제거
- `SaveCollectionAsync()`: `File.WriteAllText` -> `File.WriteAllTextAsync`, `Task.CompletedTask` 제거
- 효과: UI 스레드 블로킹 방지

#### Step 5: [중간] Fire-and-Forget 예외 처리 보강
- `App.xaml.cs`: `InitializeServicesAsync()` -> `.ContinueWith()`로 예외 진단
- `App.xaml.cs`: `OnSaveUidsRequested` 빈 catch -> `Debug.WriteLine` 추가
- `SettingsViewModel.cs`: `SaveAllAccountsAsync()` 2곳 -> `.ContinueWith()`로 예외 진단
- 효과: 무시된 예외가 디버그 출력에 기록됨

#### Step 6: [중간] 빈 예외 핸들러에 진단 정보 추가
- `OnUnhandledException`: `Debug.WriteLine`으로 예외 타입, 메시지, StackTrace 기록
- `OnDispatcherUnhandledException`: `Debug.WriteLine`으로 예외 타입, 메시지, StackTrace 기록 (`e.Handled = true` 유지)
- 효과: 미처리 예외 원인 파악 가능

#### Step 7: [낮음] 파일 인코딩 수정
- `Models/AccountBackup.cs`: 깨진 주석 -> 올바른 한글로 재작성
- `Constants/MailConstants.cs`: 깨진 주석 -> 올바른 한글로 재작성
- UTF-8로 저장

### 추가 수정 (코드 리뷰)
- `MailPollingService.cs`: `CleanupAccountResources` 메서드 위 중복 `<summary>` 주석 제거

### 검증 결과
- 빌드: 성공 (경고 6건 - 기존 NotificationService.cs CS0168, 오류 0건)
- dotnet format: 완료 (수정 파일 범위 내)
- 코드 리뷰: 심각한 문제 없음
- 데드락 패턴: 해결 확인
- 메모리 누수: 문제 없음

### 이슈 및 조치 사항
- 기존 NotificationService.cs의 CS0168 경고 6건은 수정 범위 외로 유지

### 동일 실수를 반복하지 않도록 참고
- 예외 래핑 시 반드시 원본 예외를 InnerException으로 전달할 것
- 폴링 루프에서 예외 처리는 루프 내부에 배치하여 루프가 중단되지 않도록 할 것
- 락을 이미 보유한 상태에서 같은 락을 획득하는 메서드를 호출하지 말 것 (데드락)
- async 메서드에서 동기 File I/O를 사용하지 말 것
- fire-and-forget 호출에는 반드시 예외 핸들러를 추가할 것
- 파일은 반드시 UTF-8로 저장할 것
