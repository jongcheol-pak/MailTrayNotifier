<Page x:Class="MailTrayNotifier.Views.MailSettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:res="clr-namespace:MailTrayNotifier.Resources"
    mc:Ignorable="d" d:DesignHeight="450" d:DesignWidth="800" Title="MailSettingsPage">

    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
        <StackPanel Margin="24,24,24,48" VerticalAlignment="Top">
           
            <!-- 상단 헤더 -->
            <Grid Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- 계정 추가 버튼 -->
                <ui:Button
                    Grid.Column="0"
                    Content="{x:Static res:Strings.AddAccount}"
                    Command="{Binding AddAccountCommand}"
                    Icon="Add24"
                    Appearance="Secondary"
                    HorizontalAlignment="Left" />
                
                <!-- 계정 개수 표시 -->
                <ui:TextBlock
                    Grid.Column="2"
                    Text="{Binding AccountCountText}"
                    FontSize="14"
                    FontWeight="SemiBold"
                    Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Right" />
            </Grid>

            <TextBlock
                Text="{x:Static res:Strings.NotificationOffWarning}"
                FontSize="12"
                FontWeight="Bold"
                TextWrapping="Wrap"
                Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsRefreshEnabled}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

            <!-- 계정 목록 -->
            <ItemsControl ItemsSource="{Binding Accounts}" Margin="0,12,0,0">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Expander
                            IsExpanded="{Binding IsExpanded, Mode=TwoWay}"
                            Margin="0,8,0,0">
                            <Expander.Header>
                                <Grid Margin="0,0,12,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <!--계정 오류 아이콘 -->
                                    <ui:SymbolIcon
                                        Grid.Column="0"
                                        Symbol="MailWarning24"
                                        Foreground="Red"
                                        FontSize="24"
                                        VerticalAlignment="Center"
                                        Margin="0,0,8,0"
                                        ToolTip="{Binding ErrorMessage}">
                                        <ui:SymbolIcon.Style>
                                            <Style TargetType="ui:SymbolIcon">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding HasError}" Value="True"/>
                                                            <Condition Binding="{Binding DataContext.IsRefreshEnabled, RelativeSource={RelativeSource AncestorType=Page}}" Value="True"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </MultiDataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ui:SymbolIcon.Style>
                                    </ui:SymbolIcon>

                                    <!--계정 싱크 아이콘 -->
                                    <ui:SymbolIcon
                                        Grid.Column="0"
                                        Symbol="CloudSync28"    
                                        FontSize="28"
                                        VerticalAlignment="Center"
                                        Margin="0,0,8,0">
                                        <ui:SymbolIcon.Style>
                                            <Style TargetType="ui:SymbolIcon">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding IsEnabled}" Value="True"/>
                                                            <Condition Binding="{Binding HasError}" Value="False"/>
                                                            <Condition Binding="{Binding DataContext.IsRefreshEnabled, RelativeSource={RelativeSource AncestorType=Page}}" Value="True"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </MultiDataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ui:SymbolIcon.Style>
                                    </ui:SymbolIcon>

                                    <!-- 계정 이름 TextBlock (읽기 전용) -->
                                    <ui:TextBlock
                                        Grid.Column="1"
                                        Text="{Binding DisplayName}"
                                        FontSize="14"
                                        FontWeight="SemiBold"
                                        Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"
                                        VerticalAlignment="Center"
                                        Padding="0" />

                                    <!-- ToggleSwitch -->
                                    <ui:ToggleSwitch
                                        Grid.Column="2"
                                        IsChecked="{Binding IsEnabled, Mode=TwoWay}"
                                        OnContent=""
                                        OffContent=""
                                        Margin="8,0,0,0"
                                        VerticalAlignment="Center"/>
                                </Grid>
                            </Expander.Header>

                            <Border Padding="12" Background="{ui:ThemeResource ControlFillColorDefaultBrush}" CornerRadius="8">
                                <StackPanel>
                                    <ui:TextBlock Text="{x:Static res:Strings.AccountName}" Margin="0,0,0,4" FontTypography="Body" Foreground="White"/>
                                    <ui:TextBox Margin="0,0,0,16" Text="{Binding AccountName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" IsEnabled="{Binding IsEditMode}" Foreground="WhiteSmoke" PlaceholderText="" />

                                    <ui:TextBlock Text="{x:Static res:Strings.Pop3Server}" Margin="0,0,0,4" FontTypography="Body" Foreground="White"  />
                                    <Grid Margin="0,0,0,16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="100" />
                                        </Grid.ColumnDefinitions>
                                        <ui:TextBox Grid.Column="0" Margin="0,0,8,0" Text="{Binding Pop3Server, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" IsEnabled="{Binding IsEditMode}" Foreground="WhiteSmoke" />
                                        <ui:TextBox 
                                            Grid.Column="1" 
                                            Text="{Binding Pop3PortText, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" 
                                            IsEnabled="{Binding IsEditMode}" 
                                            Foreground="WhiteSmoke" 
                                            PlaceholderText="{x:Static res:Strings.PortPlaceholder}"
                                            PreviewTextInput="NumericTextBox_PreviewTextInput"
                                            DataObject.Pasting="NumericTextBox_Pasting" />
                                    </Grid>

                                    <ui:TextBlock Text="{x:Static res:Strings.SmtpServer}" Margin="0,0,0,4" FontTypography="Body" Foreground="White"/>
                                    <Grid Margin="0,0,0,16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="100" />
                                        </Grid.ColumnDefinitions>
                                        <ui:TextBox Grid.Column="0" Margin="0,0,8,0" Text="{Binding SmtpServer, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" IsEnabled="{Binding IsEditMode}" Foreground="WhiteSmoke"/>
                                        <ui:TextBox 
                                            Grid.Column="1" 
                                            Text="{Binding SmtpPortText, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" 
                                            IsEnabled="{Binding IsEditMode}" 
                                            Foreground="WhiteSmoke" 
                                            PlaceholderText="{x:Static res:Strings.PortPlaceholder}"
                                            PreviewTextInput="NumericTextBox_PreviewTextInput"
                                            DataObject.Pasting="NumericTextBox_Pasting" />
                                    </Grid>

                                    <CheckBox Margin="0,0,0,16" IsChecked="{Binding UseSsl, Mode=TwoWay}" IsEnabled="{Binding IsEditMode}" Content="{x:Static res:Strings.UseSslLabel}" />

                                    <ui:TextBlock Text="{x:Static res:Strings.UserId}" Margin="0,0,0,4" FontTypography="Body" Foreground="White"/>
                                    <ui:TextBox Margin="0,0,0,16" Text="{Binding UserId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" IsEnabled="{Binding IsEditMode}" Foreground="WhiteSmoke"/>

                                    <ui:TextBlock Text="{x:Static res:Strings.Password}" Margin="0,0,0,4" FontTypography="Body" Foreground="White"/>
                                    <ui:PasswordBox Margin="0,0,0,16" IsEnabled="{Binding IsEditMode}" Foreground="WhiteSmoke" Password="{Binding Password, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                                    <ui:TextBlock Text="{x:Static res:Strings.SyncInterval}" Foreground="White" Margin="0,0,0,4" FontTypography="Body" />
                                    <ui:TextBox 
                                        Margin="0,0,0,16" 
                                        IsEnabled="{Binding IsEditMode}" 
                                        Foreground="WhiteSmoke" 
                                        Text="{Binding RefreshMinutesText, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                        PreviewTextInput="NumericTextBox_PreviewTextInput"
                                        DataObject.Pasting="NumericTextBox_Pasting" />

                                    <ui:TextBlock Text="{x:Static res:Strings.MailWebsite}" Foreground="White" Margin="0,0,0,4" FontTypography="Body" />
                                    <ui:TextBox Margin="0,0,0,16" IsEnabled="{Binding IsEditMode}" Foreground="WhiteSmoke" Text="{Binding MailWebUrl, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" PlaceholderText="https://mail.example.com" />

                                    <!-- 버튼 그룹 -->
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <!-- 편집 모드가 아닐 때: 수정, 삭제 버튼 -->
                                        <ui:Button
                                            Content="{x:Static res:Strings.Edit}"
                                            Click="EditAccount_Click"
                                            Tag="{Binding}"
                                            Appearance="Secondary"
                                            Margin="0,0,8,0"
                                            HorizontalAlignment="Left">
                                            <ui:Button.Style>
                                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsEditMode}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>

                                        <ui:Button
                                            Content="{x:Static res:Strings.DeleteAccount}"
                                            Command="{Binding DataContext.RemoveAccountCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                            CommandParameter="{Binding}"
                                            Appearance="Danger"
                                            Margin="0,0,0,0"
                                            HorizontalAlignment="Left">
                                            <ui:Button.Style>
                                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsEditMode}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>

                                        <!-- 편집 모드일 때: 취소, 저장 버튼 -->
                                        <ui:Button
                                            Content="{x:Static res:Strings.Cancel}"
                                            Click="CancelEdit_Click"
                                            Tag="{Binding}"
                                            Appearance="Secondary"
                                            Margin="0,0,8,0"
                                            HorizontalAlignment="Left">
                                            <ui:Button.Style>
                                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>

                                        <ui:Button
                                            Content="{x:Static res:Strings.Save}"
                                            Click="SaveEdit_Click"
                                            Tag="{Binding}"
                                            Appearance="Primary"
                                            Margin="0,0,0,0"
                                            HorizontalAlignment="Left">
                                            <ui:Button.Style>
                                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>                                       
                                    </StackPanel>

                                    <StackPanel Orientation="Vertical" HorizontalAlignment="Stretch" Margin="0,12,0,0">
                                        <StackPanel.Style>
                                            <Style TargetType="StackPanel">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasError}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </StackPanel.Style>

                                        <TextBlock
         Text="{x:Static res:Strings.ErrorLabel}"
         FontSize="12"
         Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
         VerticalAlignment="Center"
         Margin="0,0,0,2"/>

                                        <TextBox
         Text="{Binding ErrorMessage}"
         FontSize="12"
         Foreground="Red"
         VerticalAlignment="Center"
         IsReadOnly="True"
         BorderThickness="0"
         TextWrapping="Wrap"
         Background="Transparent"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </Expander>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

        </StackPanel>
    </ScrollViewer>
</Page>
